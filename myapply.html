<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <?!= include('stylesheet'); ?>
</head>
<body>
    <?!= include('loader'); ?>

    <div class="container">
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=form" class="button">新增系統變更申請</a>
      <h1 id="pageTitle">我的申請紀錄</h1>
      
      <div id="statusMessage" style="display:none; text-align: center; padding: 20px;"></div>
      
      <table id="applyTable" style="display:none;">
        <thead> <tr id="tableHeader"></tr> </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <script>
      const isApprover = <?= isApprover ? 'true' : 'false' ?>;
      if (isApprover) {
        const pageTitle = document.getElementById('pageTitle');
        if (pageTitle) pageTitle.textContent = '全部申請紀錄';
      }

      function buildPrintButton(rowNumber, status, statusMessage) {
        const button = document.createElement('button');
        if (status !== '已核准' || !rowNumber) {
          button.textContent = '待核准';
          button.disabled = true;
          button.style.backgroundColor = '#999';
          button.style.cursor = 'not-allowed';
          return button;
        }

        button.textContent = '生成申請單';
        button.addEventListener('click', function() {
          const originalText = button.textContent;
          button.disabled = true;
          button.textContent = '處理中...';
          showLoader('正在產生申請單...');

          google.script.run
            .withSuccessHandler(url => {
              if (url) {
                window.location.href = url;
                return;
              }
              hideLoader('產生失敗');
              button.disabled = false;
              button.textContent = originalText;
              statusMessage.innerText = '產生失敗：未取得文件連結。';
              statusMessage.style.display = 'block';
            })
            .withFailureHandler(err => {
              hideLoader('產生失敗');
              button.disabled = false;
              button.textContent = originalText;
              statusMessage.innerText = '產生失敗：' + err.message;
              statusMessage.style.display = 'block';
            })
            .createApplicationDocument(rowNumber);
        });

        return button;
      }

      // ✨【核心修改 2】: 全面重構 renderTable 函數以配合新的 loader
      function renderTable(dataWithHeaders) {
        // 無論成功與否，第一件事就是關閉載入動畫
        hideLoader('查詢完成！');

        const statusMessage = document.getElementById('statusMessage');
        const applyTable = document.getElementById('applyTable');

        // 檢查回傳的資料是否有效 (第一行為標頭，所以長度至少要 > 1 才算有內容)
        if (!Array.isArray(dataWithHeaders) || dataWithHeaders.length <= 1) {
            statusMessage.innerText = isApprover ? '查無申請紀錄。' : '查無您的申請紀錄。';
            statusMessage.style.display = 'block';
            applyTable.style.display = 'none'; // 確保表格是隱藏的
            return;
        }

        // 資料有效，開始建立表格
        const headers = dataWithHeaders.shift(); // 取出並移除第一行作為標頭
        const data = dataWithHeaders; // 剩下的就是資料
        const printIndex = headers.indexOf('申請單');
        const statusIndex = headers.indexOf('申請狀態');
        
        const headerRow = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        headerRow.innerHTML = '';
        tableBody.innerHTML = '';
        
        // 建立標頭
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          headerRow.appendChild(th);
        });
        
        // 建立資料列
        data.forEach(row => {
          const tr = document.createElement('tr');
          row.forEach((cell, colIndex) => {
            const td = document.createElement('td');
            if (colIndex === printIndex && printIndex !== -1) {
              const rowNumber = Number(cell);
              const status = statusIndex !== -1 ? row[statusIndex] : '';
              td.appendChild(buildPrintButton(rowNumber, status, statusMessage));
            } else {
              // 處理 null 或 undefined 的情況，顯示為空白
              td.textContent = (cell === null || cell === undefined) ? '' : cell;
            }
            tr.appendChild(td);
          });
          tableBody.appendChild(tr);
        });
        
        // 顯示表格
        statusMessage.style.display = 'none';
        applyTable.style.display = 'table';
      }

      // ✨【核心修改 3】: 修改頁面載入邏輯
      window.addEventListener('load', function() {
        // 1. 立即顯示載入動畫
        showLoader(isApprover ? '正在查詢全部申請紀錄...' : '正在查詢您的申請紀錄...');
        
        // 2. 執行後端腳本
        google.script.run
          .withSuccessHandler(renderTable)
          .withFailureHandler(err => {
            // 失敗時也要關閉載入動畫，並顯示錯誤訊息
            hideLoader('查詢失敗！');
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerText = '載入失敗：' + err.message;
            statusMessage.style.display = 'block';
          })
          .getUserApplications(); // 注意：此函數應回傳包含標頭的二維陣列
      });
    </script>
</body>
</html>
