<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <?!= include('stylesheet'); ?>
    <style>
      /* --- Page Specific Styles for Better UI/UX --- */
      
      /* Reset/Override some container styles for this page if needed */
      .container {
        width: 95%;        /* Use almost full width on larger screens */
        max-width: 1600px; /* Cap it at a very wide size to prevent line length issues on ultrawide monitors */
        margin: 0 auto;    /* Center the container */
      }

      /* Header Section */
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #ebecf0;
      }
      
      .page-header h1 {
        margin: 0;
        font-size: 24px;
        color: #172b4d;
        font-weight: 600;
      }

      /* Primary Action Button */
      .btn-primary {
        background-color: #0052cc;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        font-weight: 500;
        text-decoration: none;
        transition: background-color 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      
      .btn-primary:hover {
        background-color: #0065ff;
        text-decoration: none;
        color: white;
      }

      /* Card Container for Table */
      .table-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        border: 1px solid #dfe1e6;
        overflow: hidden;
      }

      /* Responsive Table Wrapper */
      .table-responsive {
        overflow-x: auto;
        width: 100%;
        -webkit-overflow-scrolling: touch;
      }

      /* Modern Table Styles */
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 800px; /* Ensure it doesn't squish too much */
      }

      th {
        background-color: #f4f5f7;
        color: #5e6c84;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        padding: 12px 16px;
        border-bottom: 2px solid #dfe1e6;
        border-top: none;
        border-left: none;
        border-right: none;
        white-space: nowrap;
        text-align: left;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      td {
        padding: 14px 16px;
        border-bottom: 1px solid #ebecf0;
        color: #172b4d;
        font-size: 14px;
        border-left: none;
        border-right: none;
        vertical-align: middle;
      }

      /* Remove default border from stylesheet.html if it conflicts */
      th, td {
        border: none;
        border-bottom: 1px solid #ebecf0;
      }
      
      th {
        border-bottom: 2px solid #dfe1e6;
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:hover td {
        background-color: #fafbfc;
      }

      /* Status Badges */
      .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        line-height: 1.2;
        white-space: nowrap;
      }
      
      .status-badge.approved { background-color: #e3fcef; color: #006644; } /* Green */
      .status-badge.pending { background-color: #deebff; color: #0747a6; } /* Blue */
      .status-badge.waiting { background-color: #fffae6; color: #bf2600; } /* Yellow/Orange -> actually Redish/Orange for attention */
      .status-badge.rejected { background-color: #ffebe6; color: #bf2600; } /* Red */
      .status-badge.default { background-color: #ebecf0; color: #42526e; } /* Grey */

      /* Action Button in Table */
      .table-action-btn {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 4px;
        border: 1px solid #0052cc;
        background-color: white;
        color: #0052cc;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .table-action-btn:hover:not(:disabled) {
        background-color: #ebecf0;
      }
      
      .table-action-btn:disabled {
        border-color: #ebecf0;
        background-color: #f4f5f7;
        color: #a5adba;
        cursor: not-allowed;
      }
      
      .table-action-btn.primary-action {
        background-color: #0052cc;
        color: white;
        border: 1px solid #0052cc;
      }
      
      .table-action-btn.primary-action:hover:not(:disabled) {
        background-color: #0065ff;
        border-color: #0065ff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 48px 20px;
        color: #6b778c;
        display: none;
      }
      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        color: #ebecf0;
      }
      
    </style>
</head>
<body>
    <?!= include('loader'); ?>

    <div class="container">
      <!-- Header Area -->
      <div class="page-header">
        <h1 id="pageTitle">æˆ‘çš„ç”³è«‹ç´€éŒ„</h1>
        <a href="<?= ScriptApp.getService().getUrl(); ?>?page=form" class="btn-primary">
          <span>+</span> æ–°å¢ç”³è«‹
        </a>
      </div>
      
      <!-- Status Message / Empty State -->
      <div id="statusMessage" class="empty-state"></div>
      
      <!-- Table Card -->
      <div class="table-card">
        <div class="table-responsive">
          <table id="applyTable" style="display:none;">
            <thead> <tr id="tableHeader"></tr> </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const isApprover = "<?= isApprover ?>" === "true";
      if (isApprover) {
        const pageTitle = document.getElementById('pageTitle');
        if (pageTitle) pageTitle.textContent = 'å…¨éƒ¨ç”³è«‹ç´€éŒ„';
      }

      // Helper to determine status badge class
      function getStatusBadgeClass(status) {
        if (!status) return 'default';
        if (status.includes('æ ¸å‡†') && !status.includes('å¾…')) return 'approved';
        if (status.includes('é§å›') || status.includes('æ‹’çµ•')) return 'rejected';
        if (status.includes('ç”³è«‹ä¸­') || status.includes('å¾…')) return 'pending';
        return 'default';
      }

      function buildPrintButton(rowNumber, status, statusMessage) {
        const button = document.createElement('button');
        button.className = 'table-action-btn'; // Base class
        
        if (status !== 'å·²æ ¸å‡†' || !rowNumber) {
          button.textContent = 'å¾…æ ¸å‡†';
          button.disabled = true;
          return button;
        }

        // Active state
        button.textContent = 'åˆ—å°';
        button.classList.add('primary-action');
        
        button.addEventListener('click', function() {
          const originalText = button.textContent;
          button.disabled = true;
          button.textContent = 'è™•ç†ä¸­...';
          button.classList.remove('primary-action'); // Visually indicate loading state
          showLoader('æ­£åœ¨ç”¢ç”Ÿç”³è«‹å–®...');

          google.script.run
            .withSuccessHandler(url => {
              if (url) {
                window.location.href = url;
                return;
              }
              hideLoader('ç”¢ç”Ÿå¤±æ•—');
              button.disabled = false;
              button.textContent = originalText;
              button.classList.add('primary-action');
              statusMessage.innerText = 'ç”¢ç”Ÿå¤±æ•—ï¼šæœªå–å¾—æ–‡ä»¶é€£çµã€‚';
              statusMessage.style.display = 'block';
            })
            .withFailureHandler(err => {
              hideLoader('ç”¢ç”Ÿå¤±æ•—');
              button.disabled = false;
              button.textContent = originalText;
              button.classList.add('primary-action');
              statusMessage.innerText = 'ç”¢ç”Ÿå¤±æ•—ï¼š' + err.message;
              statusMessage.style.display = 'block';
            })
            .createApplicationDocument(rowNumber);
        });

        return button;
      }

      // âœ¨ã€æ ¸å¿ƒä¿®æ”¹ 2ã€‘: å…¨é¢é‡æ§‹ renderTable å‡½æ•¸ä»¥é…åˆæ–°çš„ UI
      function renderTable(dataWithHeaders) {
        hideLoader('æŸ¥è©¢å®Œæˆï¼');

        const statusMessage = document.getElementById('statusMessage');
        const applyTable = document.getElementById('applyTable');

        // æª¢æŸ¥å›å‚³çš„è³‡æ–™æ˜¯å¦æœ‰æ•ˆ
        if (!Array.isArray(dataWithHeaders) || dataWithHeaders.length <= 1) {
            statusMessage.innerHTML = '<div class="empty-state-icon">ğŸ“­</div>' + 
                                      (isApprover ? 'ç›®å‰å°šç„¡ä»»ä½•ç”³è«‹ç´€éŒ„ã€‚' : 'æ‚¨ç›®å‰æ²’æœ‰ç”³è«‹ç´€éŒ„ã€‚');
            statusMessage.style.display = 'block';
            applyTable.style.display = 'none';
            // Hide the table card border if empty to look cleaner
            document.querySelector('.table-card').style.border = 'none';
            document.querySelector('.table-card').style.boxShadow = 'none';
            return;
        }

        const headers = dataWithHeaders.shift();
        const data = dataWithHeaders;
        const printIndex = headers.indexOf('ç”³è«‹å–®');
        const statusIndex = headers.indexOf('ç”³è«‹ç‹€æ…‹');
        
        const headerRow = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        headerRow.innerHTML = '';
        tableBody.innerHTML = '';
        
        // å»ºç«‹æ¨™é ­
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          headerRow.appendChild(th);
        });
        
        // å»ºç«‹è³‡æ–™åˆ—
        data.forEach(row => {
          const tr = document.createElement('tr');
          row.forEach((cell, colIndex) => {
            const td = document.createElement('td');
            
            // è™•ç†ã€Œç”³è«‹å–®ã€æŒ‰éˆ•æ¬„ä½
            if (colIndex === printIndex && printIndex !== -1) {
              const rowNumber = Number(cell);
              const status = statusIndex !== -1 ? row[statusIndex] : '';
              td.appendChild(buildPrintButton(rowNumber, status, statusMessage));
              td.style.textAlign = 'center'; // Center the button
            } 
            // è™•ç†ã€Œç”³è«‹ç‹€æ…‹ã€æ¬„ä½
            else if (colIndex === statusIndex && statusIndex !== -1) {
               const statusSpan = document.createElement('span');
               statusSpan.textContent = cell || 'æœªçŸ¥';
               statusSpan.className = 'status-badge ' + getStatusBadgeClass(cell);
               td.appendChild(statusSpan);
            }
            else {
              td.textContent = (cell === null || cell === undefined) ? '' : cell;
            }
            tr.appendChild(td);
          });
          tableBody.appendChild(tr);
        });
        
        // é¡¯ç¤ºè¡¨æ ¼
        statusMessage.style.display = 'none';
        applyTable.style.display = 'table';
      }

      // âœ¨ã€æ ¸å¿ƒä¿®æ”¹ 3ã€‘: ä¿®æ”¹é é¢è¼‰å…¥é‚è¼¯
      window.addEventListener('load', function() {
        showLoader(isApprover ? 'æ­£åœ¨æŸ¥è©¢å…¨éƒ¨ç”³è«‹ç´€éŒ„...' : 'æ­£åœ¨æŸ¥è©¢æ‚¨çš„ç”³è«‹ç´€éŒ„...');
        
        google.script.run
          .withSuccessHandler(renderTable)
          .withFailureHandler(err => {
            hideLoader('æŸ¥è©¢å¤±æ•—ï¼');
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerText = 'è¼‰å…¥å¤±æ•—ï¼š' + err.message;
            statusMessage.style.display = 'block';
          })
          .getUserApplications();
      });
    </script>
</body>
</html>