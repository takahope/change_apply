<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <?!= include('stylesheet'); ?>
    <style>
      /* --- Page Specific Styles for Better UI/UX --- */
      .container {
        max-width: 1400px; /* Widen for review table which has many columns */
      }

      /* Header Section */
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #ebecf0;
      }
      
      .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .back-link {
        color: #5e6c84;
        font-size: 14px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      
      .back-link:hover {
        color: #0052cc;
        text-decoration: underline;
      }
      
      .page-header h1 {
        margin: 0;
        font-size: 24px;
        color: #172b4d;
        font-weight: 600;
      }

      /* Buttons */
      .btn-primary {
        background-color: #0052cc;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      
      .btn-primary:hover:not(:disabled) {
        background-color: #0065ff;
      }
      
      .btn-primary:disabled {
        background-color: #ebecf0;
        color: #a5adba;
        cursor: not-allowed;
        box-shadow: none;
      }
      
      .btn-danger {
        background-color: #de350b;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: background-color 0.2s;
      }
      
      .btn-danger:hover {
        background-color: #bf2600;
      }

      .btn-secondary {
        background-color: white;
        color: #0052cc;
        border: 1px solid #0052cc;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
      }
      
      .btn-secondary:hover {
        background-color: #ebecf0;
      }

      /* Card Container for Table */
      .table-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        border: 1px solid #dfe1e6;
        overflow: hidden;
      }

      /* Responsive Table Wrapper */
      .table-responsive {
        overflow-x: auto;
        width: 100%;
        max-height: 70vh; /* Fixed height for sticky header */
        -webkit-overflow-scrolling: touch;
      }

      /* Modern Table Styles */
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 1000px;
      }

      th {
        background-color: #f4f5f7;
        color: #5e6c84;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        padding: 12px 16px;
        border-bottom: 2px solid #dfe1e6;
        white-space: nowrap;
        text-align: left;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 1px 0 #dfe1e6; /* Fix for sticky border */
      }
      
      /* First column sticky (checkbox) */
      th:first-child, td:first-child {
        position: sticky;
        left: 0;
        z-index: 11;
        background-color: inherit; /* inherit from row */
        border-right: 1px solid #ebecf0;
        width: 40px;
        text-align: center;
      }
      th:first-child {
        z-index: 12; /* Higher than other headers */
        background-color: #f4f5f7;
      }

      td {
        padding: 12px 16px;
        border-bottom: 1px solid #ebecf0;
        color: #172b4d;
        font-size: 14px;
        vertical-align: middle;
        background-color: white;
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:hover td {
        background-color: #fafbfc;
      }

      /* Modal Styles */
      .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(9, 30, 66, 0.54); backdrop-filter: blur(2px); }
      .modal-content { 
        background-color: #fff; 
        margin: 10% auto; 
        padding: 0; 
        border: none; 
        width: 80%; 
        max-width: 600px; 
        border-radius: 8px; 
        box-shadow: 0 8px 16px -4px rgba(9, 30, 66, 0.25), 0 0 1px rgba(9, 30, 66, 0.31);
        display: flex;
        flex-direction: column;
        max-height: 80vh;
      }
      
      .modal-header {
        padding: 16px 24px;
        border-bottom: 1px solid #ebecf0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .modal-header h3 {
        margin: 0;
        font-size: 20px;
        color: #172b4d;
      }
      
      .close-button {
        color: #5e6c84;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        padding: 4px;
        line-height: 1;
        border-radius: 4px;
      }
      
      .close-button:hover {
        background-color: #ebecf0;
        color: #172b4d;
      }
      
      .modal-body {
        padding: 24px;
        overflow-y: auto;
        white-space: pre-wrap;
        color: #172b4d;
        line-height: 1.5;
      }
      
      .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #ebecf0;
        text-align: right;
        background-color: #f4f5f7;
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 48px 20px;
        color: #6b778c;
        display: none;
      }
      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        color: #ebecf0;
      }
      
      /* Actions area above table */
      .table-actions {
        margin-bottom: 16px;
        display: flex;
        justify-content: flex-end;
      }
      
      /* Checkbox style */
      input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

    </style>
</head>
<body>
    <?!= include('loader'); ?>

    <div class="container">
      <!-- Header -->
      <div class="page-header">
        <div class="header-left">
          <a href="<?= ScriptApp.getService().getUrl(); ?>" class="back-link">
             <span>â†</span> è¿”å›é¦–é 
          </a>
          <h1>å¾…å¯©æ ¸æ¡ˆä»¶</h1>
        </div>
      </div>

      <div id="statusMessage" class="empty-state"></div>
      
      <div id="review-area" style="display:none;">
        <div class="table-actions">
           <button id="approveBtn" class="btn-primary">âœ“ æ‰¹æ¬¡æ ¸å‡†æ‰€é¸é …ç›®</button>
        </div>
        
        <div class="table-card">
          <div class="table-responsive">
            <table id="reviewTable">
              <thead> <tr id="tableHeader"></tr> </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
        
        <div id="status" style="margin-top: 10px; font-weight: bold; color: #0052cc;"></div>
      </div>
    </div>

    <!-- Assessment Details Modal -->
    <div id="assessmentModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>è®Šæ›´å‰è©•ä¼°è©³ç´°è³‡è¨Š</h3>
          <span class="close-button" onclick="closeModal('assessmentModal')">&times;</span>
        </div>
        <div id="modalBody" class="modal-body"></div>
        <div class="modal-footer">
          <button class="btn-secondary" onclick="closeModal('assessmentModal')">é—œé–‰</button>
        </div>
      </div>
    </div>

    <!-- Reject Modal -->
    <div id="rejectModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>å¡«å¯«æ‹’çµ•åŸå› </h3>
          <span class="close-button" onclick="closeModal('rejectModal')">&times;</span>
        </div>
        <div class="modal-body">
          <label for="rejectReason" style="display: block; margin-bottom: 8px; font-weight: 600;">åŸå› èªªæ˜ï¼š</label>
          <textarea id="rejectReason" rows="5" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; box-sizing: border-box;"></textarea>
          <div style="font-size: 12px; color: #6b778c; margin-top: 6px;">è«‹è©³ç´°èªªæ˜åŸå› ï¼Œæ­¤å…§å®¹å°‡ç™¼é€çµ¦ç”³è«‹äººã€‚</div>
        </div>
        <div class="modal-footer">
            <button id="cancelRejectBtn" class="btn-secondary" style="margin-right: 10px;" onclick="closeModal('rejectModal')">å–æ¶ˆ</button>
            <button id="confirmRejectBtn" class="btn-danger">ç¢ºèªæ‹’çµ•</button>
        </div>
      </div>
    </div>

    <script>
      window.addEventListener('load', function() { loadPendingApprovals(); });

      function loadPendingApprovals() {
        showLoader('æ­£åœ¨è¼‰å…¥å¾…å¯©æ ¸æ¡ˆä»¶...');
        document.getElementById('status').innerText = '';
        google.script.run
          .withSuccessHandler(renderTable)
          .withFailureHandler(handleError)
          .getPendingApprovals();
      }
      
      function renderTable(data) {
        hideLoader('è¼‰å…¥å®Œæˆï¼'); 
        
        const statusMessage = document.getElementById('statusMessage');
        const reviewArea = document.getElementById('review-area');

        if (!Array.isArray(data) || data.length <= 1) {
            statusMessage.innerHTML = '<div class="empty-state-icon">ğŸ‰</div>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„æ¡ˆä»¶ã€‚';
            statusMessage.style.display = 'block';
            reviewArea.style.display = 'none';
            return;
        }

        const tableBody = document.getElementById('tableBody');
        const headerRow = document.getElementById('tableHeader');
        tableBody.innerHTML = ''; headerRow.innerHTML = '';

        const headers = data.shift();
        
        // 1. Checkbox Column Header
        const checkTh = document.createElement('th');
        checkTh.innerHTML = '<input type="checkbox" id="selectAll">';
        headerRow.appendChild(checkTh);
        
        // 2. Data Headers (Skip raw row number)
        headers.forEach(h => {
          if (h !== 'åŸå§‹åˆ—è™Ÿ') {
            const th = document.createElement('th');
            th.textContent = h;
            headerRow.appendChild(th);
          }
        });
        
        // 3. Action Column Header
        const actionTh = document.createElement('th');
        actionTh.textContent = 'æ“ä½œ';
        headerRow.appendChild(actionTh);

        const rawRowIndex = headers.indexOf('åŸå§‹åˆ—è™Ÿ');
        const assessmentIndex = headers.indexOf('æŸ¥çœ‹è®Šæ›´å‰è©•ä¼°');

        data.forEach(row => {
          const tr = document.createElement('tr');
          const rowNumber = row[rawRowIndex];
          const assessmentDetails = row[assessmentIndex];

          // Checkbox Cell
          const checkTd = document.createElement('td');
          checkTd.innerHTML = `<input type="checkbox" class="approval-checkbox" data-row-number="${rowNumber}">`;
          tr.appendChild(checkTd);

          // Data Cells
          row.forEach((cell, index) => {
            if (index !== rawRowIndex) {
              const td = document.createElement('td');
              if (index === assessmentIndex) {
                // If this is the "View Details" column
                if (cell && cell !== '') {
                  const button = document.createElement('button');
                  button.textContent = 'æŸ¥çœ‹è©³æƒ…';
                  button.className = 'btn-secondary view-button';
                  button.dataset.details = assessmentDetails;
                  td.appendChild(button);
                } else {
                  td.textContent = '-';
                  td.style.color = '#ccc';
                }
              } else {
                td.textContent = (cell === null || cell === undefined) ? '' : cell;
              }
              tr.appendChild(td);
            }
          });
          
          // Action Cell (Reject)
          const actionTd = document.createElement('td');
          const rejectButton = document.createElement('button');
          rejectButton.textContent = 'æ‹’çµ•';
          rejectButton.className = 'btn-danger reject-button';
          rejectButton.dataset.rowNumber = rowNumber;
          actionTd.appendChild(rejectButton);
          tr.appendChild(actionTd);
          
          tableBody.appendChild(tr);
        });
        
        statusMessage.style.display = 'none';
        reviewArea.style.display = 'block';

        // Re-attach select all listener
        document.getElementById('selectAll').addEventListener('change', function() {
            document.querySelectorAll('.approval-checkbox').forEach(checkbox => { checkbox.checked = this.checked; });
        });
      }
      
      function handleError(error) { 
        hideLoader('è¼‰å…¥å¤±æ•—ï¼');
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.innerText = 'è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message; 
        statusMessage.style.display = 'block';
        document.getElementById('review-area').style.display = 'none';
      }

      // --- Event Listeners & Modal Logic ---
      let currentRejectRowNumber = null;
      
      // Delegation for dynamic table elements
      document.getElementById('review-area').addEventListener('click', function(event) {
        if (event.target.classList.contains('view-button')) {
            const details = event.target.dataset.details;
            document.getElementById('modalBody').innerText = details;
            document.getElementById('assessmentModal').style.display = 'block';
        }
        
        if (event.target.classList.contains('reject-button')) {
            currentRejectRowNumber = parseInt(event.target.dataset.rowNumber);
            document.getElementById('rejectReason').value = '';
            document.getElementById('rejectModal').style.display = 'block';
        }
      });

      function closeModal(modalId) {
         document.getElementById(modalId).style.display = "none";
      }
      
      // Close modal on outside click
      window.onclick = function(event) {
        const assessmentModal = document.getElementById('assessmentModal');
        const rejectModal = document.getElementById('rejectModal');
        if (event.target == assessmentModal) { assessmentModal.style.display = "none"; }
        if (event.target == rejectModal) { rejectModal.style.display = "none"; }
      }
      
      document.getElementById('confirmRejectBtn').onclick = function() {
        const rejectReason = document.getElementById('rejectReason').value.trim();
        if (!rejectReason) {
          alert('è«‹å¡«å¯«æ‹’çµ•åŸå› ã€‚');
          return;
        }
        
        this.disabled = true;
        document.getElementById('cancelRejectBtn').disabled = true;
        document.getElementById('status').innerText = 'è™•ç†ä¸­ï¼Œè«‹ç¨å€™...';
        
        google.script.run
          .withSuccessHandler(handleRejectSuccess)
          .withFailureHandler(handleRejectError)
          .processRejection(currentRejectRowNumber, rejectReason);
      }

      document.getElementById('approveBtn').addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.approval-checkbox:checked');
        if (checkedBoxes.length === 0) {
          alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¦æ ¸å‡†çš„é …ç›®ã€‚');
          return;
        }
        
        if(!confirm(`ç¢ºå®šè¦æ ¸å‡†é€™ ${checkedBoxes.length} ç­†ç”³è«‹å—ï¼Ÿ`)) {
            return;
        }

        const rowNumbersToApprove = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.rowNumber));
        this.disabled = true;
        this.innerText = 'è™•ç†ä¸­...';
        document.getElementById('status').innerText = 'æ­£åœ¨è™•ç†æ ¸å‡†ä½œæ¥­ï¼Œè«‹ç¨å€™...';
        
        google.script.run
          .withSuccessHandler(handleApprovalSuccess)
          .withFailureHandler(handleApprovalError)
          .processBatchApproval(rowNumbersToApprove);
      });
      
      function handleApprovalSuccess(responseMessage) {
        alert(responseMessage);
        const btn = document.getElementById('approveBtn');
        btn.disabled = false;
        btn.innerText = 'âœ“ æ‰¹æ¬¡æ ¸å‡†æ‰€é¸é …ç›®';
        loadPendingApprovals();
      }
      
      function handleApprovalError(error) {
        alert('å¯©æ ¸æ“ä½œå¤±æ•—ï¼š' + error.message);
        document.getElementById('status').innerText = 'å¯©æ ¸å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
        const btn = document.getElementById('approveBtn');
        btn.disabled = false;
        btn.innerText = 'âœ“ æ‰¹æ¬¡æ ¸å‡†æ‰€é¸é …ç›®';
      }
      
      function handleRejectSuccess(responseMessage) {
        document.getElementById('rejectModal').style.display = "none";
        document.getElementById('confirmRejectBtn').disabled = false;
        document.getElementById('cancelRejectBtn').disabled = false;
        alert(responseMessage);
        loadPendingApprovals();
      }
      
      function handleRejectError(error) {
        alert('æ‹’çµ•æ“ä½œå¤±æ•—ï¼š' + error.message);
        document.getElementById('status').innerText = 'æ‹’çµ•å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚';
        document.getElementById('confirmRejectBtn').disabled = false;
        document.getElementById('cancelRejectBtn').disabled = false;
      }
    </script>
</body>
</html>