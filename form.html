<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <?!= include('stylesheet'); ?>
    <style>
      /* --- Form Page Specific Styles --- */
      
      .container {
        max-width: 800px;
      }

      /* Header Section */
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #ebecf0;
      }
      
      .header-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .back-link {
        color: #5e6c84;
        font-size: 14px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      
      .back-link:hover {
        color: #0052cc;
        text-decoration: underline;
      }

      .page-header h1 {
        margin: 0;
        font-size: 24px;
        color: #172b4d;
        font-weight: 600;
      }
      
      .page-description {
        margin-top: -16px;
        margin-bottom: 24px;
        color: #5e6c84;
        font-size: 14px;
      }

      /* Form Card */
      .form-card {
        background: white;
        border: 1px solid #dfe1e6;
        border-radius: 8px;
        padding: 32px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      }
      
      /* Asset Selection Grid */
      .asset-selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        background-color: #f4f5f7;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 24px;
        border: 1px solid #ebecf0;
      }

      .asset-search {
        grid-column: 1 / -1;
        position: relative;
      }

      .asset-search-results {
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        right: 0;
        background-color: white;
        border: 1px solid #dfe1e6;
        border-radius: 6px;
        box-shadow: 0 6px 16px rgba(9, 30, 66, 0.2);
        max-height: 240px;
        overflow-y: auto;
        display: none;
        z-index: 10;
      }

      .asset-search-results.open {
        display: block;
      }

      .asset-search-result {
        width: 100%;
        text-align: left;
        border: none;
        background: white;
        padding: 10px 12px;
        font-size: 14px;
        color: #172b4d;
        cursor: pointer;
        transition: background-color 0.15s;
      }

      .asset-search-result:hover,
      .asset-search-result:focus {
        background-color: #f4f5f7;
        outline: none;
      }

      .asset-search-empty {
        padding: 10px 12px;
        font-size: 14px;
        color: #5e6c84;
      }

      .asset-name-row {
        grid-column: 1 / -1;
      }

      .asset-name-controls {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .asset-name-controls select {
        flex: 1 1 0;
        min-width: 0;
        width: auto;
      }

      .asset-reset-button {
        padding: 10px 14px;
        font-size: 14px;
        background-color: white;
        border: 1px solid #dfe1e6;
        border-radius: 4px;
        cursor: pointer;
        color: #5e6c84;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .asset-reset-button:hover {
        background-color: #ebecf0;
        color: #172b4d;
      }

      .apply-reason-other {
        display: none;
      }

      .apply-reason-other.visible {
        display: block;
      }
      
      .form-field {
        margin-bottom: 20px;
      }
      
      .form-field label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #172b4d;
        font-size: 14px;
      }
      
      .form-field select,
      .form-field input[type="text"],
      .form-field textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dfe1e6; /* Standard border color */
        border-radius: 4px; /* Slightly sharper corners */
        background-color: #fafbfc; /* Light background */
        font-size: 14px;
        color: #172b4d;
        transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
        box-sizing: border-box;
      }
      
      .form-field select:focus,
      .form-field input[type="text"]:focus,
      .form-field textarea:focus {
        background-color: white;
        border-color: #4c9aff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(76, 154, 255, 0.2); /* Focus ring */
      }
      
      .form-field select:disabled {
        background-color: #ebecf0;
        color: #a5adba;
        cursor: not-allowed;
      }
      
      .asset-display {
        padding: 10px 12px;
        background-color: #e3fcef; /* Greenish background for selected item */
        color: #006644;
        border: 1px solid #b3d4ff; /* Just a placeholder border, overridden below */
        border-color: rgba(9, 30, 66, 0.08);
        border-radius: 4px;
        font-weight: 500;
        font-size: 14px;
        min-height: 40px; /* Match input height */
        display: flex;
        align-items: center;
      }
      .asset-display.empty {
        background-color: #ebecf0;
        color: #5e6c84;
      }

      /* Fieldset Styling */
      fieldset {
        border: 1px solid #dfe1e6;
        border-radius: 8px;
        padding: 24px;
        margin: 0 0 24px 0;
        background-color: #fff;
      }
      
      legend {
        font-weight: 600;
        color: #0052cc;
        padding: 0 10px;
        font-size: 16px;
      }

      /* Impact Scope Styles */
      .impact-container {
        border: 1px solid #dfe1e6;
        border-radius: 4px;
        overflow: hidden;
      }
      
      .impact-scope-filters {
        display: flex;
        gap: 12px;
        padding: 12px;
        background-color: #f4f5f7;
        border-bottom: 1px solid #dfe1e6;
        flex-wrap: wrap;
      }
      
      .impact-scope-filters .filter-group {
        flex: 1;
        min-width: 120px;
      }
      
      .impact-scope-filters select {
        width: 100%;
        padding: 6px;
        font-size: 13px;
        border: 1px solid #dfe1e6;
        border-radius: 3px;
        background-color: white;
      }
      
      .impact-scope-filters button {
        padding: 6px 12px;
        font-size: 13px;
        background-color: white;
        border: 1px solid #dfe1e6;
        border-radius: 3px;
        cursor: pointer;
        color: #5e6c84;
        transition: all 0.2s;
      }
      
      .impact-scope-filters button:hover {
        background-color: #ebecf0;
        color: #172b4d;
      }

      .impact-scope-checkbox-list {
        height: 200px;
        overflow-y: auto;
        padding: 12px;
        background-color: white;
      }
      
      .checkbox-item {
        display: flex;
        align-items: center;
        padding: 6px 8px;
        border-radius: 3px;
        transition: background-color 0.1s;
      }
      
      .checkbox-item:hover {
        background-color: #f4f5f7;
      }
      
      .checkbox-item input[type="checkbox"] {
        margin-right: 10px;
        width: 16px;
        height: 16px;
        cursor: pointer;
      }
      
      .checkbox-item label {
        font-weight: normal;
        margin: 0;
        cursor: pointer;
        width: 100%;
        font-size: 14px;
        color: #172b4d;
      }

      /* Submit Button */
      .form-actions {
        margin-top: 32px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
      }
      
      #submitBtn {
        background-color: #0052cc;
        color: white;
        border: none;
        padding: 10px 24px;
        font-size: 16px;
        font-weight: 500;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        max-width: 300px;
        transition: background-color 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      #submitBtn:hover:not(:disabled) {
        background-color: #0065ff;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      
      #submitBtn:disabled {
        background-color: #ebecf0;
        color: #a5adba;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      #status {
        text-align: center;
        font-weight: 500;
        min-height: 24px;
      }

    </style>
</head>
<body>
    <?!= include('loader'); ?>
    <div class="container">
      
      <!-- Header -->
      <div class="page-header">
        <div class="header-left">
          <a href="<?= ScriptApp.getService().getUrl(); ?>" class="back-link">
             <span>←</span> 返回首頁
          </a>
          <h1>新增系統變更申請</h1>
        </div>
        <a href="<?= ScriptApp.getService().getUrl(); ?>?page=myapply" class="back-link" style="color: #0052cc;">
          查詢紀錄 <span>→</span>
        </a>
      </div>
      
      <p class="page-description">可先使用搜尋或任一選單篩選資產，選到資產後會自動帶入組別、類別與資產編號。</p>
      
      <div class="form-card">
        <form id="applyForm">
          
          <!-- Asset Selection Section -->
          <div class="asset-selection-grid">
            <div class="form-field asset-search">
              <label for="assetSearchInput">搜尋資產</label>
              <input type="text" id="assetSearchInput" placeholder="輸入資產編號、名稱、組別或類別" autocomplete="off">
              <div id="assetSearchResults" class="asset-search-results" role="listbox"></div>
            </div>
            <div class="form-field">
              <label for="groupSelect">組別</label>
              <select id="groupSelect" required> <option value="">載入中...</option> </select>
            </div>
            
            <div class="form-field">
              <label for="categorySelect">類別</label>
              <select id="categorySelect" required> <option value="">載入中...</option> </select>
            </div>
            
            <div class="form-field">
              <label for="assetIdSelect">資產編號</label>
              <select id="assetIdSelect" required> <option value="">載入中...</option> </select>
            </div>

            <div class="form-field asset-name-row">
              <label for="assetNameSelect">資產名稱</label>
              <div class="asset-name-controls">
                <select id="assetNameSelect"> <option value="">載入中...</option> </select>
                <button type="button" id="resetAssetFilters" class="asset-reset-button">清除全部</button>
              </div>
            </div>
            
            <div class="form-field" style="grid-column: 1 / -1;">
               <label>所選資產名稱</label>
               <div id="assetNameDisplay" class="asset-display empty">尚未選擇</div>
            </div>
          </div>

          <!-- Hidden Fields -->
          <input type="hidden" name="申請類別">
          <input type="hidden" name="資訊資產編號">
          <input type="hidden" name="資訊資產名稱">
          
          <!-- Basic Info -->
          <div class="form-field">
            <label for="categoryName">類別名稱</label>
            <select id="categoryName" name="類別名稱" required> <option value="">載入中...</option> </select>
          </div>

          <div class="form-field">
            <label for="applyReason">申請原因</label>
            <select id="applyReason" name="申請原因" required> <option value="">載入中...</option> </select>
          </div>

          <div class="form-field apply-reason-other" id="applyReasonOtherField">
            <label for="applyReasonOtherInput">其他原因說明</label>
            <input type="text" id="applyReasonOtherInput" placeholder="請輸入原因說明" disabled>
          </div>
          
          <div class="form-field">
            <label for="applyDescription">申請說明</label>
            <select id="applyDescription" name="申請說明" required> <option value="">載入中...</option> </select>
          </div>

          <!-- Assessment Fieldset -->
          <fieldset>
            <legend>變更前評估</legend>
            
            <div class="form-field">
              <label>影響範圍</label>
              <div class="impact-container">
                <div class="impact-scope-filters">
                  <div class="filter-group">
                    <select id="impactFilterGroup"><option value="">所有組別</option></select>
                  </div>
                  <div class="filter-group">
                    <select id="impactFilterCategory"><option value="">所有類別</option></select>
                  </div>
                  <button type="button" id="deselectAllImpact">全部取消</button>
                </div>
                <div id="impactCheckboxList" class="impact-scope-checkbox-list"></div>
              </div>
            </div>

            <div class="form-field">
              <label>事前測試</label>
              <select name="變更前評估-事前測試" required> <option value="">載入中...</option> </select>
            </div>
            
            <div class="form-field">
              <label>備份狀態說明</label>
              <select name="變更前評估-備份狀態說明" required> <option value="">載入中...</option> </select>
            </div>
            
            <div class="form-field">
              <label>風險處置方式</label>
              <select name="變更前評估-風險處置方式" required> <option value="">載入中...</option> </select>
            </div>
            
            <div class="form-field">
              <label>風險處置方式說明</label>
              <select name="變更前評估-風險處置方式說明" required> <option value="">載入中...</option> </select>
            </div>
            
            <div class="form-field">
              <label>變更前資訊</label>
              <input type="text" name="變更前資訊" placeholder="請輸入變更前的狀態或配置...">
            </div>
            
            <div class="form-field">
              <label>變更後資訊</label>
              <input type="text" name="變更後資訊" placeholder="請輸入預期的變更後狀態...">
            </div>
          </fieldset>

          <div class="form-actions">
            <button type="submit" id="submitBtn">提交申請</button>
            <div id="status"></div>
          </div>
        </form>
      </div>
    </div>

  <script>
  // --- 全域變數 ---
  let allAssetData = [];
  let assetById = new Map();
  let assetSearchIndex = [];
  let loadedDropdownOptions = {};
  let loadTasksCompleted = 0;
  const TOTAL_LOAD_TASKS = 2; // 維持不變，我們有兩項非同步載入任務
  const form = document.getElementById('applyForm');
  const groupSelect = document.getElementById('groupSelect');
  const categorySelect = document.getElementById('categorySelect');
  const assetIdSelect = document.getElementById('assetIdSelect');
  const assetNameSelect = document.getElementById('assetNameSelect');
  const assetNameDisplay = document.getElementById('assetNameDisplay');
  const assetSearchInput = document.getElementById('assetSearchInput');
  const assetSearchResults = document.getElementById('assetSearchResults');
  const resetAssetFiltersButton = document.getElementById('resetAssetFilters');
  const applyReasonSelect = document.getElementById('applyReason');
  const applyReasonOtherField = document.getElementById('applyReasonOtherField');
  const applyReasonOtherInput = document.getElementById('applyReasonOtherInput');
  const COL_ASSET_ID = 0;
  const COL_ASSET_NAME = 2;
  const COL_GROUP = 3;
  const COL_CATEGORY = 4;
  const COL_APPLY_TYPE = 6;
  const SEARCH_RESULT_LIMIT = 8;
  const OTHER_REASON_VALUE = '其他';
  let searchResultsHideTimer = null;

  // --- 頁面載入邏輯 ---
  window.addEventListener('load', function() {
    showLoader('正在初始化申請表單...');
    // 這兩行非同步呼叫維持不變
    google.script.run.withSuccessHandler(initializeAssetSelectors).withFailureHandler(handleError).getAssetData();
    google.script.run.withSuccessHandler(initializeDropdowns).withFailureHandler(handleError).getFormDropdownOptions();
  });

  // ✨【核心修正-1】: 在 initializeDropdowns 函數結尾呼叫 onTaskComplete
  function initializeDropdowns(optionsData) {
    loadedDropdownOptions = optionsData;
    for (const fieldName in optionsData) {
      const selectElement = document.querySelector(`select[name="${fieldName}"]`);
      if (selectElement) {
        populateSelect(selectElement, optionsData[fieldName]);
      }
    }
    toggleApplyReasonOtherField();
    // 新增下面這一行：通知任務管理器，此項任務已完成
    onTaskComplete('表單選項已載入...');
  }

  // ✨【核心修正-2】: 在 initializeAssetSelectors 函數結尾呼叫 onTaskComplete
  function initializeAssetSelectors(data) {
    if (!data || data.length === 0) {
      handleError({ message: '資訊資產工作表沒有資料。' });
      return;
    }
    allAssetData = data;
    buildAssetSearchIndex();
    refreshAssetSelectors('init');
    clearAssetSelection();
    populateImpactScopeFiltersAndCheckboxes();
    // 新增下面這一行：通知任務管理器，此項任務已完成
    onTaskComplete('資產資料已載入...');
  }

  // 這個函數現在會被正確呼叫了
  function onTaskComplete(statusText) {
    console.log(statusText); // 可以在控制台看到進度
    loadTasksCompleted++;
    if (loadTasksCompleted >= TOTAL_LOAD_TASKS) {
      // 當兩個任務都完成時，隱藏載入動畫
      hideLoader('表單初始化完成！');
    }
  }
  
  // 其他函數維持不變...
  function handleError(error) {
    const statusDiv = document.getElementById('status');
    // ✨【優化建議】確保發生錯誤時也能正確關閉載入動畫
    hideLoader(`載入失敗: ${error.message || '未知錯誤'}`);
    statusDiv.innerText = '錯誤：無法載入頁面資料，請檢查工作表或聯絡管理員。';
    statusDiv.style.color = 'red';
    console.error('GAS Error:', error);
  }

  function normalizeValue(value) {
    if (value === null || value === undefined) return '';
    return String(value).trim();
  }

  function getUniqueValues(rows, index, normalizer) {
    const seen = new Set();
    const values = [];
    rows.forEach(row => {
      const value = normalizer ? normalizer(row[index]) : row[index];
      if (value && !seen.has(value)) {
        seen.add(value);
        values.push(value);
      }
    });
    return values;
  }

  function formatAssetLabel(assetId, assetName, group, category) {
    const namePart = assetName || '未命名資產';
    const idPart = assetId ? `（${assetId}）` : '';
    const groupCategory = [group, category].filter(Boolean).join(' / ');
    return groupCategory ? `${namePart}${idPart} - ${groupCategory}` : `${namePart}${idPart}`;
  }

  function buildAssetSearchIndex() {
    assetById = new Map();
    assetSearchIndex = [];
    allAssetData.forEach(row => {
      const assetId = normalizeValue(row[COL_ASSET_ID]);
      if (!assetId) return;
      const assetName = row[COL_ASSET_NAME] || '';
      const group = row[COL_GROUP] || '';
      const category = row[COL_CATEGORY] || '';
      assetById.set(assetId, row);
      assetSearchIndex.push({
        assetId,
        label: formatAssetLabel(assetId, assetName, group, category),
        haystack: `${assetId} ${assetName} ${group} ${category}`.toLowerCase()
      });
    });
  }

  function clearAssetSelection(options = {}) {
    assetNameDisplay.textContent = '尚未選擇';
    assetNameDisplay.classList.add('empty');
    document.querySelector('input[name="申請類別"]').value = '';
    document.querySelector('input[name="資訊資產編號"]').value = '';
    document.querySelector('input[name="資訊資產名稱"]').value = '';
    assetNameSelect.value = '';
    if (!options.preserveSearchInput) {
      assetSearchInput.value = '';
      clearSearchResults();
    }
  }

  function resetAssetFilters() {
    groupSelect.value = '';
    categorySelect.value = '';
    assetIdSelect.value = '';
    assetNameSelect.value = '';
    clearAssetSelection();
    refreshAssetSelectors('init');
  }

  function toggleApplyReasonOtherField() {
    const shouldShow = applyReasonSelect.value === OTHER_REASON_VALUE;
    applyReasonOtherField.classList.toggle('visible', shouldShow);
    applyReasonOtherInput.disabled = !shouldShow;
    applyReasonOtherInput.required = shouldShow;
    if (shouldShow) {
      applyReasonOtherInput.focus();
    } else {
      applyReasonOtherInput.value = '';
    }
  }

  function applyAssetSelection(assetRow, options = {}) {
    const assetId = normalizeValue(assetRow[COL_ASSET_ID]);
    const assetName = assetRow[COL_ASSET_NAME];
    const group = assetRow[COL_GROUP];
    const category = assetRow[COL_CATEGORY];
    assetNameDisplay.textContent = assetName || '未命名資產';
    assetNameDisplay.classList.remove('empty');
    document.querySelector('input[name="申請類別"]').value = assetRow[COL_APPLY_TYPE] || '';
    document.querySelector('input[name="資訊資產編號"]').value = assetId || '';
    document.querySelector('input[name="資訊資產名稱"]').value = assetName || '';
    if (options.syncSearchInput) {
      assetSearchInput.value = formatAssetLabel(assetId, assetName, group, category);
    }
  }

  function filterAssets(filters) {
    return allAssetData.filter(row => {
      if (filters.group && row[COL_GROUP] !== filters.group) return false;
      if (filters.category && row[COL_CATEGORY] !== filters.category) return false;
      if (filters.assetId && normalizeValue(row[COL_ASSET_ID]) !== normalizeValue(filters.assetId)) return false;
      return true;
    });
  }

  function buildAssetLabelOptions(assetRows) {
    const seenIds = new Set();
    const options = [];
    assetRows.forEach(row => {
      const assetId = normalizeValue(row[COL_ASSET_ID]);
      if (!assetId || seenIds.has(assetId)) return;
      seenIds.add(assetId);
      options.push({
        value: assetId,
        label: formatAssetLabel(assetId, row[COL_ASSET_NAME], row[COL_GROUP], row[COL_CATEGORY])
      });
    });
    return options;
  }

  function refreshAssetSelectors(source) {
    let selectedGroup = groupSelect.value;
    let selectedCategory = categorySelect.value;
    const selectedAssetId = assetIdSelect.value;

    if (selectedGroup && selectedCategory) {
      const comboMatches = filterAssets({ group: selectedGroup, category: selectedCategory });
      if (comboMatches.length === 0) {
        if (source === 'group') {
          selectedCategory = '';
        } else if (source === 'category') {
          selectedGroup = '';
        } else {
          selectedCategory = '';
        }
      }
    }

    const groupSource = selectedCategory ? filterAssets({ category: selectedCategory }) : allAssetData;
    const categorySource = selectedGroup ? filterAssets({ group: selectedGroup }) : allAssetData;
    const assetSource = filterAssets({
      group: selectedGroup || '',
      category: selectedCategory || ''
    });

    const groupOptions = getUniqueValues(groupSource, COL_GROUP);
    const categoryOptions = getUniqueValues(categorySource, COL_CATEGORY);
    const assetIdOptions = getUniqueValues(assetSource, COL_ASSET_ID, normalizeValue);
    const assetNameOptions = buildAssetLabelOptions(assetSource);

    populateSelect(groupSelect, groupOptions, true, '請選擇組別');
    if (groupOptions.includes(selectedGroup)) {
      groupSelect.value = selectedGroup;
    }

    populateSelect(categorySelect, categoryOptions, true, '請選擇類別');
    if (categoryOptions.includes(selectedCategory)) {
      categorySelect.value = selectedCategory;
    }

    populateSelect(assetIdSelect, assetIdOptions, true, '請選擇資產編號');
    if (assetIdOptions.includes(selectedAssetId)) {
      assetIdSelect.value = selectedAssetId;
    } else if (selectedAssetId) {
      clearAssetSelection();
    }

    populateSelectWithOptions(assetNameSelect, assetNameOptions, true, '請選擇資產名稱');
    if (assetNameOptions.some(option => option.value === selectedAssetId)) {
      assetNameSelect.value = selectedAssetId;
    }
  }

  function clearSearchResults() {
    assetSearchResults.innerHTML = '';
    assetSearchResults.classList.remove('open');
  }

  function renderSearchResults(results) {
    assetSearchResults.innerHTML = '';
    if (results.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'asset-search-empty';
      empty.textContent = '找不到符合的資產';
      assetSearchResults.appendChild(empty);
      assetSearchResults.classList.add('open');
      return;
    }

    results.forEach(result => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'asset-search-result';
      item.setAttribute('role', 'option');
      item.dataset.assetId = result.assetId;
      item.textContent = result.label;
      item.addEventListener('click', function() {
        selectAssetById(result.assetId, true);
      });
      assetSearchResults.appendChild(item);
    });
    assetSearchResults.classList.add('open');
  }

  function updateSearchResults(query) {
    const normalized = query.trim().toLowerCase();
    if (!normalized) {
      clearSearchResults();
      return;
    }
    const matches = assetSearchIndex
      .filter(item => item.haystack.includes(normalized))
      .slice(0, SEARCH_RESULT_LIMIT);
    renderSearchResults(matches);
  }

  function selectAssetById(assetId, syncSearchInput) {
    const normalizedAssetId = normalizeValue(assetId);
    const assetRow = assetById.get(normalizedAssetId);
    if (!assetRow) return;
    groupSelect.value = assetRow[COL_GROUP] || '';
    categorySelect.value = assetRow[COL_CATEGORY] || '';
    assetIdSelect.value = normalizedAssetId;
    applyAssetSelection(assetRow, { syncSearchInput: syncSearchInput });
    refreshAssetSelectors('asset');
    clearSearchResults();
  }

  function populateImpactScopeFiltersAndCheckboxes() {
    const impactFilterGroup = document.getElementById('impactFilterGroup');
    const impactFilterCategory = document.getElementById('impactFilterCategory');
    const checkboxList = document.getElementById('impactCheckboxList');
    checkboxList.innerHTML = '載入中...';

    const groups = getUniqueValues(allAssetData, COL_GROUP);
    const categories = getUniqueValues(allAssetData, COL_CATEGORY);
    populateSelect(impactFilterGroup, groups, true, '所有組別');
    populateSelect(impactFilterCategory, categories, true, '所有類別');
    
    checkboxList.innerHTML = '';
    allAssetData.forEach((row, index) => {
      const assetName = row[COL_ASSET_NAME];
      if (!assetName) return;

      const itemDiv = document.createElement('div');
      itemDiv.className = 'checkbox-item';
      itemDiv.dataset.group = row[COL_GROUP] || '';
      itemDiv.dataset.category = row[COL_CATEGORY] || '';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `impact_cb_${index}`;
      checkbox.value = assetName;
      
      const label = document.createElement('label');
      label.htmlFor = `impact_cb_${index}`;
      label.textContent = assetName;
      
      itemDiv.appendChild(checkbox);
      itemDiv.appendChild(label);
      checkboxList.appendChild(itemDiv);
    });
  }

  function applyImpactScopeFilter() {
    const groupFilter = document.getElementById('impactFilterGroup').value;
    const categoryFilter = document.getElementById('impactFilterCategory').value;
    const allItems = document.querySelectorAll('#impactCheckboxList .checkbox-item');

    allItems.forEach(item => {
      const matchesGroup = !groupFilter || item.dataset.group === groupFilter;
      const matchesCategory = !categoryFilter || item.dataset.category === categoryFilter;
      
      if (matchesGroup && matchesCategory) {
        item.style.display = 'flex';
      } else {
        item.style.display = 'none';
      }
    });
  }

  function populateSelect(selectElement, optionsArray, addDefaultOption = true, defaultText = '請選擇...') {
    selectElement.innerHTML = '';
    if (addDefaultOption) {
      selectElement.innerHTML = `<option value="">${defaultText}</option>`;
    }
    optionsArray.forEach(optionValue => {
      if (optionValue) {
        const option = document.createElement('option');
        option.value = optionValue;
        option.textContent = optionValue;
        selectElement.appendChild(option);
      }
    });
  }

  function populateSelectWithOptions(selectElement, optionsArray, addDefaultOption = true, defaultText = '請選擇...') {
    selectElement.innerHTML = '';
    if (addDefaultOption) {
      selectElement.innerHTML = `<option value="">${defaultText}</option>`;
    }
    optionsArray.forEach(optionData => {
      if (optionData && optionData.value) {
        const option = document.createElement('option');
        option.value = optionData.value;
        option.textContent = optionData.label || optionData.value;
        selectElement.appendChild(option);
      }
    });
  }

  // --- 事件監聽 ---
  assetSearchInput.addEventListener('input', function() {
    updateSearchResults(this.value);
  });

  assetSearchInput.addEventListener('focus', function() {
    if (this.value.trim()) {
      updateSearchResults(this.value);
    }
  });

  assetSearchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      const firstResult = assetSearchResults.querySelector('.asset-search-result');
      if (firstResult) {
        e.preventDefault();
        firstResult.click();
      }
    }
    if (e.key === 'Escape') {
      clearSearchResults();
    }
  });

  assetSearchInput.addEventListener('blur', function() {
    searchResultsHideTimer = setTimeout(clearSearchResults, 150);
  });

  assetSearchResults.addEventListener('mousedown', function() {
    if (searchResultsHideTimer) {
      clearTimeout(searchResultsHideTimer);
    }
  });

  groupSelect.addEventListener('change', function() {
    refreshAssetSelectors('group');
  });

  categorySelect.addEventListener('change', function() {
    refreshAssetSelectors('category');
  });

  assetIdSelect.addEventListener('change', function() {
    const selectedAssetId = this.value;
    if (!selectedAssetId) {
      clearAssetSelection();
      refreshAssetSelectors('asset');
      return;
    }
    selectAssetById(selectedAssetId, true);
  });

  assetNameSelect.addEventListener('change', function() {
    const selectedAssetId = this.value;
    if (!selectedAssetId) {
      clearAssetSelection();
      refreshAssetSelectors('asset');
      return;
    }
    selectAssetById(selectedAssetId, true);
  });

  resetAssetFiltersButton.addEventListener('click', resetAssetFilters);
  applyReasonSelect.addEventListener('change', toggleApplyReasonOtherField);

  document.getElementById('impactFilterGroup').addEventListener('change', applyImpactScopeFilter);
  document.getElementById('impactFilterCategory').addEventListener('change', applyImpactScopeFilter);
  document.getElementById('deselectAllImpact').addEventListener('click', function() {
    document.querySelectorAll('#impactCheckboxList input[type="checkbox"]').forEach(cb => cb.checked = false);
  });

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('status').innerText = '提交中，請稍候...';
    document.getElementById('status').style.color = '#0052cc';
    
    const formData = {};
    this.querySelectorAll('input, textarea, select').forEach(el => {
      if (!el.name || el.type === 'checkbox') return;
      formData[el.name] = el.value;
    });

    const applyReason = formData['申請原因'] || '';
    const otherReasonInput = applyReasonOtherInput.value.trim();
    if (applyReason === OTHER_REASON_VALUE && !otherReasonInput) {
      applyReasonOtherInput.focus();
      document.getElementById('status').innerText = '請填寫其他原因說明。';
      document.getElementById('status').style.color = '#de350b';
      document.getElementById('submitBtn').disabled = false;
      return;
    }
    const finalApplyReason = applyReason === OTHER_REASON_VALUE ? otherReasonInput : applyReason;
    const applyDescription = formData['申請說明'] || '';
    if (finalApplyReason && applyDescription) {
      formData['申請說明'] = `因${finalApplyReason}，故進行${applyDescription}變更`;
    } else if (finalApplyReason) {
      formData['申請說明'] = `因${finalApplyReason}進行變更`;
    } else if (applyDescription) {
      formData['申請說明'] = `進行${applyDescription}變更`;
    }

    const checkedImpactItems = document.querySelectorAll('#impactCheckboxList input[type="checkbox"]:checked');
    const selectedImpactValues = Array.from(checkedImpactItems).map(cb => cb.value);
    formData['變更前評估-影響範圍'] = selectedImpactValues.join(', ');

    google.script.run
      .withSuccessHandler(function(response) {
        document.getElementById('status').innerText = response;
        if (response.includes('成功')) {
            document.getElementById('status').style.color = '#006644';
          form.reset();
          initializeAssetSelectors(allAssetData);
          initializeDropdowns(loadedDropdownOptions);
          clearAssetSelection();
          // 提交成功後，取消所有勾選並清除篩選
          document.querySelectorAll('#impactCheckboxList input[type="checkbox"]').forEach(cb => cb.checked = false);
          document.getElementById('impactFilterGroup').value = '';
          document.getElementById('impactFilterCategory').value = '';
          applyImpactScopeFilter();
        } else {
            document.getElementById('status').style.color = '#de350b';
        }
        document.getElementById('submitBtn').disabled = false;
      })
      .withFailureHandler(function(err) {
        handleError(err);
        document.getElementById('submitBtn').disabled = false;
      })
      .submitApplication(formData);
  });
</script>
  </body>
</html>
